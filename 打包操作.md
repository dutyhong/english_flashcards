# 打包操作指南 (EAS Build)

本指南介绍如何使用 Expo Application Services (EAS) 将应用打包为 Android APK 和 iOS IPA 文件。

## 1. 准备工作

在开始打包之前，请确保完成以下步骤：

1.  **注册 Expo 账号**
    *   访问 [expo.dev](https://expo.dev) 注册账号。

2.  **提交代码到 Git**
    *   EAS Build 基于 Git 提交进行打包。确保所有改动都已提交。
    ```bash
    git add .
    git commit -m "Ready for build"
    ```

3.  **检查 App ID (Bundle Identifier)**
    *   打开 `app.json`，确认 `ios.bundleIdentifier` 和 `android.package` 已经设置好（例如 `com.duty.englishflashcards`）。

## 2. 安装工具并登录

在终端执行以下命令：

```bash
# 1. 修复 npm 权限问题（如果之前报错的话）
sudo chown -R $(whoami) ~/.npm

# 2. 全局安装 EAS CLI
sudo npm install -g eas-cli

# 3. 登录 Expo 账号
eas login
```

## 3. 配置项目

在项目根目录运行：

```bash
eas build:configure
```
*   当询问平台时，选择 `All` (Android + iOS)。
*   这会生成一个 `eas.json` 文件。

## 4. 打包 Android (APK)

为了生成可以直接安装到手机的 APK 文件（而不是 Google Play 专用的 AAB），请修改 `eas.json` 中的 `preview` 部分：

**修改后的 `eas.json` 片段：**
```json
{
  "build": {
    "preview": {
      "distribution": "internal",
      "android": {
        "buildType": "apk"
      },
      "env": {
        "NPM_CONFIG_LEGACY_PEER_DEPS": "true"
      }
    },
    "production": {
        "env": {
            "NPM_CONFIG_LEGACY_PEER_DEPS": "true"
        }
    }
    // ...
  }
}
```

**开始打包：**
```bash
eas build -p android --profile preview
```
*   打包完成后，终端会显示一个下载链接（及二维码），下载 APK 发送到安卓手机即可安装。

## 5. 打包 iOS (IPA)

**注意：需要 Apple Developer Program 账号 ($99/年)。**

如果你有开发者账号，运行：

```bash
eas build -p ios --profile production
```

*   EAS 会引导你登录 Apple ID。
*   它会自动处理证书（Certificates）和描述文件（Provisioning Profiles）。
*   生成的 `.ipa` 文件通常需要通过 TestFlight 分发或上传 App Store。

## 6. Profile 区别说明 (Preview vs Production)

在执行打包命令时，`--profile` 参数决定了包的类型和用途：

### Android
*   **`preview`**: 生成 **.apk** 文件。
    *   **用途**：内部测试，可以直接发给任何人下载安装，没有任何限制。
*   **`production`**: 生成 **.aab** (App Bundle) 文件。
    *   **用途**：**必须**上传到 Google Play 商店才能分发，不能直接安装到手机上。

### iOS
*   **`preview` (Ad Hoc)**: 生成 **.ipa** 文件。
    *   **用途**：内部小范围测试。
    *   **限制**：**极其严格**。必须先在苹果开发者后台注册每台测试设备的 **UDID**。只有注册过的设备才能安装，其他人即使拿到包也装不上。
*   **`production` (App Store)**: 生成 **.ipa** 文件。
    *   **用途**：发布到 App Store 或 **TestFlight**。
    *   **限制**：只能通过 TestFlight (邀请测试) 或 App Store (公开下载) 进行分发。不能通过网页直接下载安装。

## 7. 常见问题

*   **依赖安装失败**：如果是 `npm install` 报错，请在本地运行 `rm -rf node_modules package-lock.json && npm install --legacy-peer-deps` 并提交 Git 后重试。
*   **API Key 只有代码里的生效**：如果你使用了 `.env` 文件，EAS Build 默认读不到。请去 [expo.dev](https://expo.dev) 网站的项目设置 -> Secrets 里添加环境变量。
*   **网络超时**：打包过程需要上传代码到国外服务器，如果卡住请开启 VPN 代理。
